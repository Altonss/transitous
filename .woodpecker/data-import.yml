# SPDX-FileCopyrightText: 2024 Jonah Br√ºchert <jbb@kaidan.im>
# SPDX-License-Identifier: CC0-1.0

when:
  - event: push
    branch: [main, work/jbb/woodpecker]
    path:
      - 'feeds/*'
      - 'src/*'
      - 'ci/*'
      - 'ci/container/*'
      - 'motis/*'
      - '.woodpecker/*.yml'
  - event: cron
    cron: daily-import

steps:
  fetch:
    image: ghcr.io/public-transport/transitous/import:latest
    pull: true
    environment:
      GITHUB_TOKEN:
        from_secret: github_issues_token
    commands:
      - git submodule update --init --checkout --remote
      - ./ci/fetch-feeds.py timer
  import:
    image: ghcr.io/public-transport/transitous/import:latest
    pull: true
    commands:
      - motis --version
      - ./src/generate-attribution.py
      - ./src/generate-motis-config.py import
      # Remove files that we want to regenerate
      - bash -c "rm -f out/data/meta/{adr_extend.json,tt.json,matches.json,osr_footpath.json} out/data/shape*"
      # Start import
      - cd out && motis import -c config.yml > motis-import.log && rm motis-import.log && cd ..
      - src/generate-motis-config.py full
  push:
    image: ghcr.io/public-transport/transitous/import:latest
    environment:
      RSYNC_PRIVATE_KEY:
        from_secret: RSYNC_PRIVATE_KEY
    commands:
      - echo "$${RSYNC_PRIVATE_KEY}" > deploy_key
      - chmod 600 ./deploy_key
      - "rsync -avz --progress -e 'ssh -i ./deploy_key -p 2222 -o StrictHostKeyChecking=no' out/meta out/data/*.bin out/data/adr rsync@crunchy.spline.de:data/"
      - "rsync -avz --progress -e 'ssh -i ./deploy_key -p 2222 -o StrictHostKeyChecking=no' out/config.yml rsync@crunchy.spline.de:data/"
      - rm deploy_key
